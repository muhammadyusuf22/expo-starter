<!doctype html>
<html>
  <head>
    <base target="_top" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />

    <style>
      .no-scrollbar::-webkit-scrollbar {
        display: none;
      }

      .no-scrollbar {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }

      .fade-in {
        animation: fadeIn 0.3s ease-in-out;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }

        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .modal {
        transition: opacity 0.25s ease;
      }

      body.modal-active {
        overflow-x: hidden;
        overflow-y: visible !important;
      }

      /* Toast Notification Styles */
      .toast-container {
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 9999;
        pointer-events: none;
      }

      .toast {
        padding: 14px 20px;
        border-radius: 12px;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        gap: 10px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        animation:
          toastIn 0.3s ease,
          toastOut 0.3s ease 2.7s forwards;
        pointer-events: auto;
        max-width: 90vw;
      }

      .toast-success {
        background: linear-gradient(135deg, #10b981, #059669);
        color: white;
      }

      .toast-error {
        background: linear-gradient(135deg, #ef4444, #dc2626);
        color: white;
      }

      .toast-info {
        background: linear-gradient(135deg, #3b82f6, #2563eb);
        color: white;
      }

      .toast-warning {
        background: linear-gradient(135deg, #f59e0b, #d97706);
        color: white;
      }

      .toast i {
        font-size: 18px;
      }

      .toast span {
        font-size: 14px;
        font-weight: 500;
      }

      @keyframes toastIn {
        from {
          opacity: 0;
          transform: translateY(-20px);
        }

        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @keyframes toastOut {
        from {
          opacity: 1;
          transform: translateY(0);
        }

        to {
          opacity: 0;
          transform: translateY(-20px);
        }
      }
    </style>
  </head>

  <body
    class="bg-gray-50 text-gray-800 font-sans h-screen flex flex-col overflow-hidden relative"
  >
    <!-- Toast Container -->
    <div id="toastContainer" class="toast-container"></div>

    <!-- TOP HEADER -->
    <div class="bg-white shadow-sm p-4 z-10 sticky top-0">
      <div class="flex justify-between items-center">
        <div>
          <h1 class="text-xl font-bold text-gray-900">
            Spen<span class="text-emerald-500">duit</span>
          </h1>
          <p class="text-xs text-gray-500" id="currentDate">Memuat...</p>
        </div>
        <button
          onclick="switchPage('settings')"
          class="h-8 w-8 rounded-full bg-gray-100 flex items-center justify-center text-gray-600 hover:bg-emerald-50 hover:text-emerald-500 transition-colors"
        >
          <i class="fas fa-cog"></i>
        </button>
      </div>
    </div>

    <!-- MAIN CONTENT AREA -->
    <div
      id="mainContent"
      class="flex-1 overflow-y-auto no-scrollbar pb-24 p-4 relative"
    >
      <div
        id="loader"
        class="absolute inset-0 flex items-center justify-center bg-gray-50 z-50"
      >
        <div
          class="animate-spin rounded-full h-10 w-10 border-b-2 border-emerald-500"
        ></div>
      </div>

      <!-- ERROR MESSAGE BANNER (Hidden by default) -->
      <div
        id="errorBanner"
        class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4"
        role="alert"
      >
        <strong class="font-bold">Error!</strong>
        <span class="block sm:inline" id="errorMessage"></span>
      </div>

      <!-- PAGE: DASHBOARD -->
      <div id="page-dashboard" class="fade-in space-y-4">
        <!-- Balance Card -->
        <div
          class="bg-gradient-to-r from-emerald-500 to-teal-600 rounded-2xl p-5 text-white shadow-lg shadow-emerald-200"
        >
          <p class="text-emerald-100 text-sm mb-1">Sisa Uang (Balance)</p>
          <h2 class="text-3xl font-bold mb-4" id="displayBalance">Rp 0</h2>
          <div
            class="flex justify-between bg-white/10 rounded-lg p-3 backdrop-blur-sm"
          >
            <div>
              <p class="text-emerald-100 text-xs">Pemasukan</p>
              <p class="font-semibold text-sm" id="displayIncome">Rp 0</p>
            </div>
            <div class="text-right">
              <p class="text-emerald-100 text-xs">Pengeluaran</p>
              <p class="font-semibold text-sm" id="displayExpense">Rp 0</p>
            </div>
          </div>
        </div>

        <!-- Financial Health -->
        <div
          class="bg-white rounded-xl p-4 shadow-sm border border-gray-100 flex items-center justify-between"
        >
          <div>
            <p class="text-xs text-gray-400 font-bold uppercase">
              Savings Rate
            </p>
            <p class="text-lg font-bold text-gray-800">
              <span id="displaySavingsRate">0</span>%
            </p>
          </div>
          <div
            class="h-10 w-10 rounded-full bg-blue-50 flex items-center justify-center text-blue-500"
          >
            <i class="fas fa-chart-line"></i>
          </div>
        </div>

        <!-- NEW: BUDGET MONITORING (PREMIUM FEATURE) -->
        <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-100">
          <h3 class="text-sm font-bold text-gray-700 mb-3">
            Monitoring Anggaran
          </h3>
          <div id="budgetList" class="space-y-4">
            <!-- Budget Items Injected via JS -->
            <p class="text-xs text-gray-400">Memuat data anggaran...</p>
          </div>
        </div>

        <!-- Expense Chart -->
        <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-100">
          <h3 class="text-sm font-bold text-gray-700 mb-4">
            Pengeluaran per Kategori
          </h3>
          <div class="h-48 relative">
            <canvas id="expenseChart"></canvas>
          </div>
        </div>

        <!-- Recent Transactions -->
        <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-100">
          <h3 class="text-sm font-bold text-gray-700 mb-3">
            Transaksi Terakhir
          </h3>
          <div id="recentList" class="space-y-3"></div>
          <div id="recentLoadMore" class="hidden"></div>
        </div>
      </div>

      <!-- PAGE: INPUT -->
      <div id="page-input" class="hidden fade-in">
        <h2 class="text-xl font-bold mb-4">Tambah Transaksi</h2>
        <form
          id="transForm"
          onsubmit="handleFormSubmit(event)"
          class="space-y-4"
        >
          <div class="grid grid-cols-2 gap-2 bg-gray-200 p-1 rounded-lg">
            <label class="cursor-pointer text-center">
              <input
                type="radio"
                name="type"
                value="Expense"
                checked
                class="peer sr-only"
                onchange="toggleType(this)"
              />
              <div
                class="py-2 rounded-md text-sm font-semibold text-gray-500 peer-checked:bg-white peer-checked:text-red-500 peer-checked:shadow transition-all"
              >
                Pengeluaran
              </div>
            </label>
            <label class="cursor-pointer text-center">
              <input
                type="radio"
                name="type"
                value="Income"
                class="peer sr-only"
                onchange="toggleType(this)"
              />
              <div
                class="py-2 rounded-md text-sm font-semibold text-gray-500 peer-checked:bg-white peer-checked:text-emerald-500 peer-checked:shadow transition-all"
              >
                Pemasukan
              </div>
            </label>
          </div>

          <div>
            <label class="block text-xs font-medium text-gray-500 mb-1"
              >Tanggal</label
            ><input
              type="date"
              name="date"
              id="inputDate"
              required
              class="w-full bg-white border border-gray-300 rounded-lg p-3"
            />
          </div>
          <div>
            <label class="block text-xs font-medium text-gray-500 mb-1"
              >Jumlah (Rp)</label
            ><input
              type="text"
              name="amount"
              id="amountInput"
              placeholder="0"
              required
              oninput="formatCurrencyInput(this)"
              class="w-full bg-white border border-gray-300 rounded-lg p-3 text-lg font-bold"
            />
          </div>
          <div>
            <label class="block text-xs font-medium text-gray-500 mb-1"
              >Kategori</label
            ><select
              name="category"
              id="categorySelect"
              class="w-full bg-white border border-gray-300 rounded-lg p-3"
            ></select>
          </div>
          <div>
            <label class="block text-xs font-medium text-gray-500 mb-1"
              >Wallet</label
            ><select
              name="walletId"
              id="walletSelect"
              class="w-full bg-white border border-gray-300 rounded-lg p-3"
            >
              <option value="WALLET-CASH">ðŸ’µ Cash (Default)</option>
            </select>
          </div>
          <div>
            <label class="block text-xs font-medium text-gray-500 mb-1"
              >Catatan</label
            ><input
              type="text"
              name="note"
              placeholder="Opsional"
              class="w-full bg-white border border-gray-300 rounded-lg p-3"
            />
          </div>

          <button
            type="submit"
            id="btnSave"
            class="w-full bg-emerald-600 text-white font-bold py-4 rounded-xl shadow-lg active:scale-95 transition-transform flex justify-center items-center gap-2"
          >
            <span>Simpan Transaksi</span>
          </button>
        </form>
      </div>

      <!-- PAGE: HISTORY -->
      <div id="page-history" class="hidden fade-in">
        <div class="flex justify-between items-end mb-4">
          <h2 class="text-xl font-bold">Riwayat Transaksi</h2>
        </div>
        <div class="mb-4 relative">
          <i
            class="fas fa-search absolute left-3 top-3 text-gray-400 text-sm"
          ></i>
          <input
            type="text"
            id="searchInput"
            onkeyup="handleSearch(this.value)"
            placeholder="Cari..."
            class="w-full bg-white border border-gray-200 rounded-lg py-2 pl-9 pr-4 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500"
          />
        </div>
        <div
          id="historyList"
          class="space-y-3 bg-white rounded-xl p-4 shadow-sm border border-gray-100 min-h-[300px]"
        ></div>
        <p class="text-center text-xs text-gray-400 mt-4">
          Klik item untuk mengedit.
        </p>
      </div>

      <!-- PAGE: GOALS -->
      <div id="page-goals" class="hidden fade-in space-y-4">
        <div class="flex justify-between items-center mb-2">
          <h2 class="text-xl font-bold">Target Tabungan</h2>
          <button
            onclick="openGoalModal()"
            class="bg-emerald-600 text-white px-3 py-2 rounded-lg text-sm font-semibold"
          >
            <i class="fas fa-plus mr-1"></i> Tambah
          </button>
        </div>
        <!-- Goals Summary -->
        <div
          class="bg-gradient-to-r from-purple-500 to-indigo-600 rounded-2xl p-4 text-white shadow-lg"
        >
          <p class="text-purple-100 text-xs">Total Progress</p>
          <p class="text-2xl font-bold" id="goalsOverallProgress">0%</p>
          <div class="flex justify-between text-xs mt-2">
            <span>Terkumpul: <span id="goalsTotalSaved">Rp 0</span></span>
            <span>Target: <span id="goalsTotalTarget">Rp 0</span></span>
          </div>
        </div>
        <div id="goalsList" class="space-y-3"></div>
      </div>

      <!-- PAGE: WALLETS -->
      <div id="page-wallets" class="hidden fade-in space-y-4">
        <div class="flex justify-between items-center mb-2">
          <h2 class="text-xl font-bold">Dompet Saya</h2>
          <button
            onclick="openWalletModal()"
            class="bg-blue-600 text-white px-3 py-2 rounded-lg text-sm font-semibold"
          >
            <i class="fas fa-plus mr-1"></i> Tambah
          </button>
        </div>
        <!-- Net Worth -->
        <div
          class="bg-gradient-to-r from-blue-500 to-cyan-600 rounded-2xl p-4 text-white shadow-lg"
        >
          <p class="text-blue-100 text-xs">Total Kekayaan Bersih</p>
          <p class="text-2xl font-bold" id="netWorthDisplay">Rp 0</p>
        </div>
        <div id="walletsList" class="space-y-3"></div>
        <!-- Transfer Button -->
        <button
          onclick="openTransferModal()"
          class="w-full bg-white border-2 border-dashed border-gray-300 text-gray-500 py-3 rounded-xl text-sm font-semibold hover:border-blue-500 hover:text-blue-500 transition-colors"
        >
          <i class="fas fa-exchange-alt mr-2"></i> Transfer Antar Wallet
        </button>
      </div>

      <!-- PAGE: BUDGET -->
      <div id="page-budget" class="hidden fade-in space-y-4">
        <div class="flex justify-between items-center mb-2">
          <h2 class="text-xl font-bold">Atur Budget</h2>
        </div>

        <div
          class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden"
        >
          <div id="manageBudgetList" class="divide-y divide-gray-100">
            <!-- Items injected via JS -->
          </div>
        </div>
      </div>

      <!-- PAGE: SETTINGS -->
      <div id="page-settings" class="hidden fade-in space-y-4">
        <div class="flex justify-between items-center mb-2">
          <h2 class="text-xl font-bold">Pengaturan</h2>
        </div>

        <div class="space-y-4">
          <!-- Menu Group -->
          <div
            class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden"
          >
            <div class="p-4 border-b border-gray-100 bg-gray-50">
              <h3
                class="font-bold text-gray-600 text-sm uppercase tracking-wider"
              >
                Keuangan
              </h3>
            </div>

            <button
              onclick="switchPage('budget')"
              class="w-full flex items-center justify-between p-4 bg-white hover:bg-emerald-50 transition-colors group"
            >
              <div class="flex items-center gap-3">
                <div
                  class="w-10 h-10 rounded-full bg-emerald-100 flex items-center justify-center text-emerald-600 group-hover:scale-110 transition-transform"
                >
                  <i class="fas fa-chart-pie"></i>
                </div>
                <div class="text-left">
                  <p class="font-bold text-gray-800">Atur Budget</p>
                  <p class="text-xs text-gray-400">Kelola batasan bulanan</p>
                </div>
              </div>
              <i class="fas fa-chevron-right text-gray-300"></i>
            </button>

            <button
              onclick="switchPage('wallets')"
              class="w-full flex items-center justify-between p-4 bg-white hover:bg-emerald-50 transition-colors group border-t border-gray-100"
            >
              <div class="flex items-center gap-3">
                <div
                  class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 group-hover:scale-110 transition-transform"
                >
                  <i class="fas fa-wallet"></i>
                </div>
                <div class="text-left">
                  <p class="font-bold text-gray-800">Daftar Wallet</p>
                  <p class="text-xs text-gray-400">Cash, Bank, E-Wallet</p>
                </div>
              </div>
              <i class="fas fa-chevron-right text-gray-300"></i>
            </button>
          </div>

          <div
            class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden"
          >
            <div class="p-4 border-b border-gray-100 bg-gray-50">
              <h3
                class="font-bold text-gray-600 text-sm uppercase tracking-wider"
              >
                Lainnya
              </h3>
            </div>
            <button
              class="w-full flex items-center justify-between p-4 bg-white hover:bg-gray-50 transition-colors"
            >
              <div class="flex items-center gap-3">
                <div
                  class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center text-gray-500"
                >
                  <i class="fas fa-info-circle"></i>
                </div>
                <div class="text-left w-full">
                  <div class="flex justify-between items-center w-full">
                    <p class="font-bold text-gray-800">Tentang</p>
                    <span
                      class="text-[10px] bg-green-100 text-green-600 px-2 py-0.5 rounded-full border border-green-200"
                      >Verified Original</span
                    >
                  </div>
                  <p class="text-xs text-gray-400">
                    SpenDuit v1.0 by
                    <a
                      href="https://lynk.id/hexaflow"
                      target="_blank"
                      class="text-green-500 hover:underline"
                      >@hexaflow</a
                    >
                  </p>
                </div>
              </div>
            </button>
          </div>
        </div>
      </div>

      <!-- PAGE: REPORTS -->
      <div id="page-reports" class="hidden fade-in space-y-4">
        <h2 class="text-xl font-bold mb-2">Laporan Bulanan</h2>
        <!-- Report Generator -->
        <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-100">
          <h3 class="text-sm font-bold text-gray-700 mb-3">
            Buat Laporan Baru
          </h3>
          <div class="grid grid-cols-2 gap-2 mb-3">
            <select
              id="reportMonth"
              class="border rounded-lg p-2 text-sm"
            ></select>
            <select
              id="reportYear"
              class="border rounded-lg p-2 text-sm"
            ></select>
          </div>
          <button
            onclick="handleGenerateReport()"
            id="btnGenReport"
            class="w-full bg-amber-500 text-white py-3 rounded-lg font-semibold"
          >
            <i class="fas fa-file-pdf mr-2"></i> Generate Laporan
          </button>
        </div>
        <!-- Reports List -->
        <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-100">
          <h3 class="text-sm font-bold text-gray-700 mb-3">Riwayat Laporan</h3>
          <div id="reportsList" class="space-y-2"></div>
        </div>
      </div>
    </div>

    <div
      id="editModal"
      class="fixed inset-0 z-[60] hidden overflow-y-auto"
      aria-labelledby="modal-title"
      role="dialog"
      aria-modal="true"
    >
      <div
        class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity"
        onclick="closeEditModal()"
      ></div>
      <div
        class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0"
      >
        <div
          class="relative transform overflow-hidden rounded-lg bg-white text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-lg w-full mb-16"
        >
          <div class="bg-white px-4 pb-4 pt-5 sm:p-6 sm:pb-4">
            <div class="flex justify-between items-center mb-4">
              <h3 class="text-lg font-semibold leading-6 text-gray-900">
                Edit Transaksi
              </h3>
              <button
                onclick="closeEditModal()"
                class="text-gray-400 hover:text-gray-500"
              >
                <i class="fas fa-times"></i>
              </button>
            </div>
            <form
              id="editForm"
              onsubmit="handleEditSubmit(event)"
              class="space-y-3"
            >
              <input type="hidden" name="editId" id="editId" />
              <div class="grid grid-cols-2 gap-2">
                <div>
                  <label class="text-xs text-gray-500">Tanggal</label
                  ><input
                    type="date"
                    name="editDate"
                    id="editDate"
                    class="w-full border rounded p-2 text-sm"
                  />
                </div>
                <div>
                  <label class="text-xs text-gray-500">Tipe</label
                  ><select
                    name="editType"
                    id="editType"
                    onchange="populateEditCategories()"
                    class="w-full border rounded p-2 text-sm"
                  >
                    <option value="Expense">Pengeluaran</option>
                    <option value="Income">Pemasukan</option>
                  </select>
                </div>
              </div>
              <div>
                <label class="text-xs text-gray-500">Jumlah</label
                ><input
                  type="text"
                  name="editAmount"
                  id="editAmount"
                  oninput="formatCurrencyInput(this)"
                  class="w-full border rounded p-2 font-bold"
                />
              </div>
              <div>
                <label class="text-xs text-gray-500">Kategori</label
                ><select
                  name="editCategory"
                  id="editCategory"
                  class="w-full border rounded p-2 text-sm"
                ></select>
              </div>
              <div>
                <label class="text-xs text-gray-500">Catatan</label
                ><input
                  type="text"
                  name="editNote"
                  id="editNote"
                  class="w-full border rounded p-2 text-sm"
                />
              </div>
              <div class="mt-5 flex gap-2">
                <button
                  type="button"
                  onclick="handleDelete()"
                  id="btnDelete"
                  class="w-1/3 justify-center rounded-md bg-red-50 px-3 py-3 text-sm font-semibold text-red-600 shadow-sm hover:bg-red-100"
                >
                  <i class="fas fa-trash mr-1"></i> Hapus
                </button>
                <button
                  type="submit"
                  id="btnUpdate"
                  class="w-2/3 justify-center rounded-md bg-emerald-600 px-3 py-3 text-sm font-semibold text-white shadow-sm hover:bg-emerald-500"
                >
                  Simpan Perubahan
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- MODAL: GOAL -->
    <div id="goalModal" class="fixed inset-0 z-[60] hidden overflow-y-auto">
      <div
        class="fixed inset-0 bg-gray-500 bg-opacity-75"
        onclick="closeGoalModal()"
      ></div>
      <div class="flex min-h-full items-end justify-center p-4">
        <div
          class="relative bg-white rounded-lg shadow-xl w-full max-w-lg mb-16 p-4"
        >
          <h3 class="text-lg font-semibold mb-4">Tambah Target</h3>
          <form
            id="goalForm"
            onsubmit="handleGoalSubmit(event)"
            class="space-y-3"
          >
            <input type="hidden" id="goalId" />
            <div>
              <label class="text-xs text-gray-500">Nama Target</label
              ><input
                type="text"
                id="goalName"
                required
                class="w-full border rounded p-2"
                placeholder="Contoh: Beli iPhone"
              />
            </div>
            <div>
              <label class="text-xs text-gray-500">Target (Rp)</label
              ><input
                type="text"
                id="goalTarget"
                required
                oninput="formatCurrencyInput(this)"
                class="w-full border rounded p-2"
                placeholder="15.000.000"
              />
            </div>
            <div>
              <label class="text-xs text-gray-500">Deadline</label
              ><input
                type="date"
                id="goalDeadline"
                class="w-full border rounded p-2"
              />
            </div>
            <div>
              <label class="text-xs text-gray-500">Icon</label
              ><input
                type="text"
                id="goalIcon"
                class="w-full border rounded p-2"
                value="ðŸŽ¯"
              />
            </div>
            <button
              type="submit"
              id="btnSaveGoal"
              class="w-full bg-purple-600 text-white py-3 rounded-lg font-semibold"
            >
              Simpan Target
            </button>
          </form>
        </div>
      </div>
    </div>

    <!-- MODAL: ADD TO GOAL -->
    <div
      id="addToGoalModal"
      class="fixed inset-0 z-[60] hidden overflow-y-auto"
    >
      <div
        class="fixed inset-0 bg-gray-500 bg-opacity-75"
        onclick="closeAddToGoalModal()"
      ></div>
      <div class="flex min-h-full items-end justify-center p-4">
        <div
          class="relative bg-white rounded-lg shadow-xl w-full max-w-lg mb-16 p-4"
        >
          <h3 class="text-lg font-semibold mb-4">ðŸ’° Tambah Tabungan</h3>
          <input type="hidden" id="addToGoalId" />
          <p class="text-sm text-gray-500 mb-2">
            Target: <span id="addToGoalName" class="font-bold"></span>
          </p>
          <div class="space-y-3">
            <div>
              <label class="text-xs text-gray-500">Jumlah (Rp)</label
              ><input
                type="text"
                id="addToGoalAmount"
                required
                oninput="formatCurrencyInput(this)"
                class="w-full border rounded p-2"
                placeholder="500.000"
              />
            </div>
            <div>
              <label class="text-xs text-gray-500">Dari Wallet</label
              ><select
                id="addToGoalWallet"
                class="w-full border rounded p-2"
              ></select>
            </div>
            <div>
              <label class="text-xs text-gray-500">Catatan</label
              ><input
                type="text"
                id="addToGoalNote"
                class="w-full border rounded p-2"
                placeholder="Contoh: Dari gaji"
              />
            </div>
          </div>
          <button
            onclick="handleAddToGoal()"
            id="btnAddToGoal"
            class="w-full bg-emerald-600 text-white py-3 rounded-lg font-semibold mt-3"
          >
            Tambah
          </button>
        </div>
      </div>
    </div>

    <!-- MODAL: WITHDRAW FROM GOAL -->
    <div
      id="withdrawFromGoalModal"
      class="fixed inset-0 z-[60] hidden overflow-y-auto"
    >
      <div
        class="fixed inset-0 bg-gray-500 bg-opacity-75"
        onclick="closeWithdrawFromGoalModal()"
      ></div>
      <div class="flex min-h-full items-end justify-center p-4">
        <div
          class="relative bg-white rounded-lg shadow-xl w-full max-w-lg mb-16 p-4"
        >
          <h3 class="text-lg font-semibold mb-4">ðŸ’¸ Tarik Dana</h3>
          <input type="hidden" id="withdrawGoalId" />
          <p class="text-sm text-gray-500 mb-2">
            Target: <span id="withdrawGoalName" class="font-bold"></span>
          </p>
          <p class="text-sm text-emerald-600 mb-3">
            Saldo tersedia:
            <span id="withdrawGoalBalance" class="font-bold"></span>
          </p>
          <div class="space-y-3">
            <div>
              <label class="text-xs text-gray-500">Jumlah (Rp)</label
              ><input
                type="text"
                id="withdrawGoalAmount"
                required
                oninput="formatCurrencyInput(this)"
                class="w-full border rounded p-2"
                placeholder="100.000"
              />
            </div>
            <div>
              <label class="text-xs text-gray-500">Ke Wallet</label
              ><select
                id="withdrawGoalWallet"
                class="w-full border rounded p-2"
              ></select>
            </div>
            <div>
              <label class="text-xs text-gray-500">Alasan</label
              ><input
                type="text"
                id="withdrawGoalNote"
                class="w-full border rounded p-2"
                placeholder="Contoh: Dana darurat"
              />
            </div>
          </div>
          <button
            onclick="handleWithdrawFromGoal()"
            id="btnWithdrawGoal"
            class="w-full bg-red-500 text-white py-3 rounded-lg font-semibold mt-3"
          >
            Tarik Dana
          </button>
        </div>
      </div>
    </div>

    <!-- MODAL: GOAL HISTORY -->
    <div
      id="goalHistoryModal"
      class="fixed inset-0 z-[60] hidden overflow-y-auto"
    >
      <div
        class="fixed inset-0 bg-gray-500 bg-opacity-75"
        onclick="closeGoalHistoryModal()"
      ></div>
      <div class="flex min-h-full items-end justify-center p-4">
        <div
          class="relative bg-white rounded-t-2xl shadow-xl w-full max-w-lg max-h-[80vh] overflow-hidden"
        >
          <div class="sticky top-0 bg-white border-b p-4">
            <div class="flex justify-between items-center">
              <div>
                <h3 class="text-lg font-semibold" id="goalHistoryTitle">
                  History
                </h3>
                <p class="text-sm text-gray-500">
                  Saldo:
                  <span
                    id="goalHistoryBalance"
                    class="font-bold text-emerald-600"
                  ></span>
                </p>
              </div>
              <button
                onclick="closeGoalHistoryModal()"
                class="text-gray-400 hover:text-gray-600"
              >
                <i class="fas fa-times text-xl"></i>
              </button>
            </div>
            <div class="flex gap-2 mt-3">
              <button
                onclick="openAddToGoalFromHistory()"
                class="flex-1 bg-emerald-50 text-emerald-600 py-2 rounded-lg text-sm font-semibold"
              >
                <i class="fas fa-plus mr-1"></i>Topup
              </button>
              <button
                onclick="openWithdrawFromHistory()"
                class="flex-1 bg-red-50 text-red-500 py-2 rounded-lg text-sm font-semibold"
              >
                <i class="fas fa-minus mr-1"></i>Tarik
              </button>
            </div>
          </div>
          <div
            class="p-4 overflow-y-auto max-h-[50vh]"
            id="goalHistoryList"
          ></div>
        </div>
      </div>
    </div>

    <!-- MODAL: WALLET -->
    <div id="walletModal" class="fixed inset-0 z-[60] hidden overflow-y-auto">
      <div
        class="fixed inset-0 bg-gray-500 bg-opacity-75"
        onclick="closeWalletModal()"
      ></div>
      <div class="flex min-h-full items-end justify-center p-4">
        <div
          class="relative bg-white rounded-lg shadow-xl w-full max-w-lg mb-16 p-4"
        >
          <h3 class="text-lg font-semibold mb-4">Tambah Wallet</h3>
          <form
            id="walletForm"
            onsubmit="handleWalletSubmit(event)"
            class="space-y-3"
          >
            <input type="hidden" id="walletId" />
            <div>
              <label class="text-xs text-gray-500">Nama Wallet</label
              ><input
                type="text"
                id="walletName"
                required
                class="w-full border rounded p-2"
                placeholder="Contoh: BCA"
              />
            </div>
            <div>
              <label class="text-xs text-gray-500">Tipe</label
              ><select id="walletType" class="w-full border rounded p-2">
                <option value="bank">Bank</option>
                <option value="ewallet">E-Wallet</option>
                <option value="cash">Cash</option>
                <option value="other">Lainnya</option>
              </select>
            </div>
            <div>
              <label class="text-xs text-gray-500">Saldo Awal (Rp)</label
              ><input
                type="text"
                id="walletInitial"
                oninput="formatCurrencyInput(this)"
                class="w-full border rounded p-2"
                value="0"
              />
            </div>
            <div>
              <label class="text-xs text-gray-500">Icon</label
              ><input
                type="text"
                id="walletIcon"
                class="w-full border rounded p-2"
                value="ðŸ’°"
              />
            </div>
            <button
              type="submit"
              id="btnSaveWallet"
              class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold"
            >
              Simpan Wallet
            </button>
          </form>
        </div>
      </div>
    </div>

    <!-- MODAL: TRANSFER -->
    <div id="transferModal" class="fixed inset-0 z-[60] hidden overflow-y-auto">
      <div
        class="fixed inset-0 bg-gray-500 bg-opacity-75"
        onclick="closeTransferModal()"
      ></div>
      <div class="flex min-h-full items-end justify-center p-4">
        <div
          class="relative bg-white rounded-lg shadow-xl w-full max-w-lg mb-16 p-4"
        >
          <h3 class="text-lg font-semibold mb-4">Transfer Antar Wallet</h3>
          <div class="space-y-3">
            <div>
              <label class="text-xs text-gray-500">Dari Wallet</label
              ><select
                id="transferFrom"
                class="w-full border rounded p-2"
              ></select>
            </div>
            <div>
              <label class="text-xs text-gray-500">Ke Wallet</label
              ><select
                id="transferTo"
                class="w-full border rounded p-2"
              ></select>
            </div>
            <div>
              <label class="text-xs text-gray-500">Jumlah (Rp)</label
              ><input
                type="text"
                id="transferAmount"
                required
                oninput="formatCurrencyInput(this)"
                class="w-full border rounded p-2"
              />
            </div>
            <div>
              <label class="text-xs text-gray-500">Catatan</label
              ><input
                type="text"
                id="transferNote"
                class="w-full border rounded p-2"
                placeholder="Opsional"
              />
            </div>
            <button
              onclick="handleTransfer()"
              id="btnTransfer"
              class="w-full bg-cyan-600 text-white py-3 rounded-lg font-semibold"
            >
              Transfer
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- MODAL: WALLET HISTORY -->
    <div
      id="walletHistoryModal"
      class="fixed inset-0 z-[60] hidden overflow-y-auto"
    >
      <div
        class="fixed inset-0 bg-gray-500 bg-opacity-75"
        onclick="closeWalletHistoryModal()"
      ></div>
      <div class="flex min-h-full items-end justify-center p-4">
        <div
          class="relative bg-white rounded-t-2xl shadow-xl w-full max-w-lg max-h-[80vh] overflow-hidden"
        >
          <div
            class="sticky top-0 bg-white border-b p-4 flex justify-between items-center"
          >
            <div>
              <h3 class="text-lg font-semibold" id="walletHistoryTitle">
                History
              </h3>
              <p class="text-sm text-gray-500" id="walletHistoryBalance">
                Saldo: Rp 0
              </p>
            </div>
            <button
              onclick="closeWalletHistoryModal()"
              class="text-gray-400 hover:text-gray-600"
            >
              <i class="fas fa-times text-xl"></i>
            </button>
          </div>
          <div
            class="p-4 overflow-y-auto max-h-[60vh]"
            id="walletHistoryList"
          ></div>
        </div>
      </div>
    </div>

    <!-- MODAL: CONFIRM DIALOG -->
    <div id="confirmModal" class="fixed inset-0 z-[70] hidden">
      <div
        class="fixed inset-0 bg-gray-900 bg-opacity-50 backdrop-blur-sm"
      ></div>
      <div class="fixed inset-0 flex items-center justify-center p-4">
        <div
          class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-5 transform transition-all"
        >
          <div class="text-center mb-4">
            <div
              id="confirmIcon"
              class="w-14 h-14 mx-auto rounded-full bg-red-100 flex items-center justify-center mb-3"
            >
              <i class="fas fa-trash text-red-500 text-xl"></i>
            </div>
            <h3 id="confirmTitle" class="text-lg font-bold text-gray-800">
              Konfirmasi
            </h3>
            <p id="confirmMessage" class="text-sm text-gray-500 mt-2">
              Apakah Anda yakin?
            </p>
          </div>
          <div class="flex gap-3">
            <button
              onclick="closeConfirmModal()"
              class="flex-1 bg-gray-100 text-gray-700 py-3 rounded-xl font-semibold hover:bg-gray-200 transition-colors"
            >
              Batal
            </button>
            <button
              id="confirmBtn"
              onclick="executeConfirm()"
              class="flex-1 bg-red-500 text-white py-3 rounded-xl font-semibold hover:bg-red-600 transition-colors"
            >
              Hapus
            </button>
          </div>
        </div>
      </div>
    </div>
    <!-- MODAL: EDIT BUDGET -->
    <div id="editBudgetModal" class="fixed inset-0 z-[60] hidden">
      <div
        class="fixed inset-0 bg-gray-900 bg-opacity-50 backdrop-blur-sm"
        onclick="closeEditBudgetModal()"
      ></div>
      <div class="fixed inset-0 flex items-center justify-center p-4">
        <div
          class="bg-white rounded-2xl shadow-xl w-full max-w-sm p-5 animate-slide-up"
        >
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-bold text-gray-800">Edit Budget</h3>
            <button
              onclick="closeEditBudgetModal()"
              class="text-gray-400 hover:text-gray-600"
            >
              <i class="fas fa-times text-xl"></i>
            </button>
          </div>
          <div class="space-y-4">
            <div>
              <label class="block text-xs font-medium text-gray-400 mb-1"
                >Kategori</label
              >
              <input
                type="text"
                id="editBudgetCategory"
                readonly
                class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 text-gray-500 font-medium cursor-not-allowed"
              />
            </div>
            <div>
              <label class="block text-xs font-medium text-gray-400 mb-1"
                >Limit Bulanan (Rp)</label
              >
              <input
                type="text"
                id="editBudgetLimit"
                oninput="formatCurrencyInput(this)"
                class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 text-gray-800 font-medium focus:ring-2 focus:ring-emerald-500 outline-none transition-all"
                placeholder="0"
              />
            </div>
            <button
              id="btnSaveBudget"
              onclick="handleSaveBudget()"
              class="w-full bg-emerald-500 text-white font-bold py-3 rounded-xl shadow-lg shadow-emerald-500/30 hover:bg-emerald-600 transition-all active:scale-95"
            >
              Simpan Perubahan
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- NAVIGATION (5 tabs) -->
    <div
      class="bg-white border-t border-gray-200 fixed bottom-0 w-full pb-safe pt-2 px-2 h-20 flex justify-around items-start z-40"
    >
      <button
        onclick="switchPage('dashboard')"
        id="nav-dashboard"
        class="flex flex-col items-center gap-1 text-emerald-500 w-14 transition-colors"
      >
        <i class="fas fa-home text-lg"></i
        ><span class="text-[9px] font-medium">Home</span>
      </button>
      <button
        onclick="switchPage('goals')"
        id="nav-goals"
        class="flex flex-col items-center gap-1 text-gray-400 w-14 transition-colors"
      >
        <i class="fas fa-bullseye text-lg"></i
        ><span class="text-[9px] font-medium">Goals</span>
      </button>
      <button
        onclick="switchPage('input')"
        class="-mt-6 bg-emerald-600 text-white h-12 w-12 rounded-full shadow-lg shadow-emerald-300 flex items-center justify-center active:scale-90 transition-transform"
      >
        <i class="fas fa-plus text-lg"></i>
      </button>
      <button
        onclick="switchPage('wallets')"
        id="nav-wallets"
        class="flex flex-col items-center gap-1 text-gray-400 w-14 transition-colors"
      >
        <i class="fas fa-wallet text-lg"></i
        ><span class="text-[9px] font-medium">Wallet</span>
      </button>
      <!-- Budget Removed -->
      <button
        onclick="switchPage('reports')"
        id="nav-reports"
        class="flex flex-col items-center gap-1 text-gray-400 w-14 transition-colors"
      >
        <i class="fas fa-file-alt text-lg"></i
        ><span class="text-[9px] font-medium">Report</span>
      </button>
    </div>

    <script>
      const expenseCategories = [
        "Makanan & Minuman",
        "Transportasi",
        "Belanja",
        "Tagihan & Utilitas",
        "Hiburan",
        "Kesehatan",
        "Lainnya",
      ];
      const incomeCategories = [
        "Gaji Utama",
        "Freelance / Side Job",
        "Bonus / THR",
        "Investasi",
        "Lainnya",
      ];
      let chartInstance = null,
        globalTransactionData = [];

      // Toast Notification Function
      function showToast(message, type = "success") {
        const container = document.getElementById("toastContainer");
        const icons = {
          success: "fa-check-circle",
          error: "fa-times-circle",
          warning: "fa-exclamation-triangle",
          info: "fa-info-circle",
        };
        const toast = document.createElement("div");
        toast.className = "toast toast-" + type;
        toast.innerHTML =
          '<i class="fas ' + icons[type] + '"></i><span>' + message + "</span>";
        container.appendChild(toast);
        setTimeout(() => {
          if (toast.parentNode) toast.remove();
        }, 3000);
      }

      // Confirm Modal Functions
      let confirmCallback = null;
      function openConfirmModal(title, message, callback, btnText = "Hapus") {
        document.getElementById("confirmTitle").innerText = title;
        document.getElementById("confirmMessage").innerText = message;
        document.getElementById("confirmBtn").innerText = btnText;
        document.getElementById("confirmModal").classList.remove("hidden");
        confirmCallback = callback;
      }
      function closeConfirmModal() {
        document.getElementById("confirmModal").classList.add("hidden");
        confirmCallback = null;
      }
      function executeConfirm() {
        if (confirmCallback) confirmCallback();
        closeConfirmModal();
      }

      // Loading for pages
      function showPageLoading(listId) {
        document.getElementById(listId).innerHTML =
          '<div class="flex justify-center items-center py-12"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-emerald-500"></div></div>';
      }

      window.onload = function () {
        document.getElementById("inputDate").valueAsDate = new Date();
        document.getElementById("currentDate").innerText =
          new Date().toLocaleDateString("id-ID", {
            weekday: "long",
            year: "numeric",
            month: "long",
            day: "numeric",
          });
        // Fix: Explicitly set to Expense categories on load
        populateCategories("Expense", "categorySelect");
        // Load wallets for dropdown
        loadWalletsForDropdown();
        loadData();
      };

      function loadWalletsForDropdown() {
        google.script.run
          .withSuccessHandler(function (data) {
            globalWalletsData = data.wallets || [];
            const select = document.getElementById("walletSelect");
            select.innerHTML = "";
            if (!data.wallets || data.wallets.length === 0) {
              select.innerHTML =
                '<option value="WALLET-CASH">ðŸ’µ Cash (Default)</option>';
            } else {
              data.wallets.forEach((w) => {
                select.innerHTML +=
                  '<option value="' +
                  w.id +
                  '">' +
                  w.icon +
                  " " +
                  w.name +
                  "</option>";
              });
            }
          })
          .getWalletsData();
      }

      function switchPage(pageId) {
        const allPages = [
          "dashboard",
          "input",
          "history",
          "goals",
          "wallets",
          "reports",
          "budget",
          "settings",
        ];
        // Only bottom nav items
        const navPages = ["dashboard", "goals", "wallets", "reports"];

        allPages.forEach((p) => {
          const el = document.getElementById("page-" + p);
          if (el) el.classList.add("hidden");
        });

        navPages.forEach((n) => {
          const nav = document.getElementById("nav-" + n);
          if (nav) nav.classList.replace("text-emerald-500", "text-gray-400");
        });

        const targetPage = document.getElementById("page-" + pageId);
        if (targetPage) targetPage.classList.remove("hidden");

        // Highlight nav if it exists
        if (navPages.includes(pageId)) {
          const activeNav = document.getElementById("nav-" + pageId);
          if (activeNav)
            activeNav.classList.replace("text-gray-400", "text-emerald-500");
        }

        // Load data based on page
        if (pageId === "dashboard") loadData();
        if (pageId === "history") renderHistoryList(globalTransactionData);
        if (pageId === "goals") loadGoals();
        if (pageId === "wallets") loadWallets();
        if (pageId === "budget") loadBudgets();
        if (pageId === "reports") loadReports();
        if (pageId === "input") {
          // Reload wallets and reset category to Expense
          loadWalletsForDropdown();
          populateCategories("Expense", "categorySelect");
          // Reset the type radio to Expense
          const expenseRadio = document.querySelector(
            'input[name="type"][value="Expense"]',
          );
          if (expenseRadio) expenseRadio.checked = true;
        }
      }

      function toggleType(radio) {
        populateCategories(radio.value, "categorySelect");
      }

      // Currency Formatting Helpers
      function formatCurrencyInput(input) {
        let value = input.value.replace(/\D/g, "");
        if (value === "") {
          input.value = "";
          return;
        }
        input.value = new Intl.NumberFormat("id-ID").format(value);
      }
      function parseCurrencyValue(value) {
        if (!value) return 0;
        return parseInt(value.toString().replace(/\./g, ""), 10) || 0;
      }

      function populateCategories(type, selectId) {
        const select = document.getElementById(selectId);
        select.innerHTML = "";
        (type === "Income" ? incomeCategories : expenseCategories).forEach(
          (cat) => {
            const opt = document.createElement("option");
            opt.value = cat;
            opt.innerText = cat;
            select.appendChild(opt);
          },
        );
      }

      function loadData() {
        document.getElementById("loader").classList.remove("hidden");
        document.getElementById("errorBanner").classList.add("hidden");
        google.script.run
          .withSuccessHandler(renderDashboard)
          .withFailureHandler(handleError)
          .getDashboardData();
      }

      function handleError(err) {
        document.getElementById("loader").classList.add("hidden");
        document.getElementById("errorBanner").classList.remove("hidden");
        document.getElementById("errorMessage").innerText =
          err.message || "Terjadi kesalahan koneksi.";
      }

      function renderDashboard(data) {
        document.getElementById("loader").classList.add("hidden");
        if (data.error) {
          handleError(data);
          return;
        }

        globalTransactionData = data.allTransactions || [];
        document.getElementById("displayIncome").innerText = data.totalIncome;
        document.getElementById("displayExpense").innerText = data.totalExpense;
        document.getElementById("displayBalance").innerText = data.balance;
        document.getElementById("displaySavingsRate").innerText =
          data.savingsRate;

        // RENDER BUDGET LIST (NEW)
        const budgetList = document.getElementById("budgetList");
        budgetList.innerHTML = "";
        if (data.budgetOverview && data.budgetOverview.length > 0) {
          data.budgetOverview.forEach((b) => {
            budgetList.innerHTML += `
            <div>
              <div class="flex justify-between text-xs mb-1">
                <span class="font-semibold text-gray-700">${b.category}</span>
                <span class="text-gray-500">${b.fmtSpent} / ${b.fmtLimit}</span>
              </div>
              <div class="w-full bg-gray-200 rounded-full h-2.5">
                <div class="${b.statusColor} h-2.5 rounded-full transition-all duration-500" style="width: ${b.percentage}%"></div>
              </div>
            </div>`;
          });
        } else {
          budgetList.innerHTML =
            '<p class="text-xs text-gray-400 text-center">Belum ada data anggaran.</p>';
        }

        // Initial Render Recent
        recentLimit = 10;
        renderRecentWithPagination();

        renderChart(data.chartLabels, data.chartValues);
      }

      let recentLimit = 10;
      function renderRecentWithPagination() {
        const list = globalTransactionData.slice(0, recentLimit);
        renderTransactionList(list, "recentList", false);

        const loadMoreContainer = document.getElementById("recentLoadMore");
        if (globalTransactionData.length > recentLimit) {
          loadMoreContainer.innerHTML = `
              <button onclick="handleLoadMoreRecent()" class="w-full py-2 text-sm font-semibold text-emerald-600 bg-emerald-50 rounded-lg hover:bg-emerald-100 transition-colors mt-2">
                See More (${globalTransactionData.length - recentLimit} more)
              </button>
            `;
          loadMoreContainer.classList.remove("hidden");
        } else {
          loadMoreContainer.innerHTML = "";
          loadMoreContainer.classList.add("hidden");
        }
      }

      function handleLoadMoreRecent() {
        recentLimit += 10;
        renderRecentWithPagination();
      }

      function renderTransactionList(transactions, containerId, isClickable) {
        const listContainer = document.getElementById(containerId);
        listContainer.innerHTML = "";
        if (!transactions || transactions.length === 0) {
          listContainer.innerHTML =
            '<div class="text-center py-8 text-gray-300"><i class="fas fa-receipt text-4xl mb-2"></i><p class="text-sm">Tidak ada data</p></div>';
          return;
        }
        transactions.forEach((item) => {
          const isExpense = item.rawType === "Expense";
          const icon = isExpense ? "fa-arrow-up" : "fa-arrow-down";
          const colorClass = isExpense
            ? "text-red-500 bg-red-50"
            : "text-emerald-500 bg-emerald-50";
          const sign = isExpense ? "-" : "+";
          const clickAttr = isClickable
            ? `onclick='openEditModal(${JSON.stringify(item)})'`
            : "";
          const cursorClass = isClickable
            ? "cursor-pointer active:bg-gray-100"
            : "";

          listContainer.innerHTML += `
          <div ${clickAttr} class="flex items-center justify-between p-3 border-b border-gray-50 last:border-0 hover:bg-gray-50 transition-colors rounded-lg ${cursorClass}">
            <div class="flex items-center gap-3 min-w-0 flex-1">
              <div class="h-10 w-10 rounded-full ${colorClass} flex items-center justify-center text-sm shrink-0"><i class="fas ${icon}"></i></div>
              <div class="overflow-hidden">
                <p class="font-bold text-gray-800 text-sm truncate">${
                  item.category
                }</p>
                <p class="text-xs text-gray-400 truncate">${item.date} â€¢ ${
                  item.note || "-"
                }</p>
              </div>
            </div>
            <div class="text-right shrink-0 ml-2">
               <p class="font-bold text-sm ${
                 isExpense ? "text-red-500" : "text-emerald-600"
               } whitespace-nowrap">${sign} ${item.fmtAmount}</p>
               ${
                 isClickable
                   ? '<p class="text-[10px] text-gray-300"><i class="fas fa-pen"></i></p>'
                   : ""
               }
            </div>
          </div>`;
        });
      }

      function renderHistoryList(data) {
        renderTransactionList(data, "historyList", true);
      }

      function handleSearch(q) {
        const lower = q.toLowerCase();
        const filtered = globalTransactionData.filter(
          (i) =>
            (i.category && i.category.toLowerCase().includes(lower)) ||
            (i.note && i.note.toLowerCase().includes(lower)) ||
            (i.amount && i.amount.toString().includes(lower)),
        );
        renderHistoryList(filtered);
      }

      // FORM HANDLERS
      function handleFormSubmit(e) {
        e.preventDefault();
        setLoading("btnSave", true);

        const f = document.forms["transForm"];
        const formData = {
          type: f.type.value,
          date: f.date.value,
          amount: parseCurrencyValue(f.amount.value),
          category: f.category.value,
          walletId: f.walletId.value,
          note: f.note.value,
        };

        google.script.run
          .withSuccessHandler((res) => {
            setLoading("btnSave", false, "Simpan Transaksi");
            if (res.success) {
              document.getElementById("transForm").reset();
              document.getElementById("inputDate").valueAsDate = new Date();
              switchPage("dashboard");
            } else showToast("Error: " + res.message, "error");
          })
          .saveTransaction(formData);
      }

      function openEditModal(item) {
        document.getElementById("editModal").classList.remove("hidden");
        document.getElementById("editId").value = item.id;
        // Date conversion
        try {
          const parts = item.rawDate.toString().split("T")[0].split("-"); // simple check
          if (item.rawDate.toString().indexOf("/") > -1) {
            // DD/MM/YYYY
            // Handled by backend mostly, but for input value:
            // Use simple method if string is ISO, otherwise assume today or try parse
            // Ideally backend sends YYYY-MM-DD in rawDate, let's assume valid ISO or DD/MM/YYYY
          }
          // Fallback date setting
          document.getElementById("editDate").valueAsDate = new Date(
            item.rawDate,
          );
        } catch (e) {
          document.getElementById("editDate").valueAsDate = new Date();
        }

        document.getElementById("editType").value = item.rawType;
        populateCategories(item.rawType, "editCategory");
        document.getElementById("editCategory").value = item.category;

        // Format Amount for Edit
        document.getElementById("editAmount").value = new Intl.NumberFormat(
          "id-ID",
        ).format(item.amount);

        document.getElementById("editNote").value = item.note;
      }

      function closeEditModal() {
        document.getElementById("editModal").classList.add("hidden");
      }
      function populateEditCategories() {
        populateCategories(
          document.getElementById("editType").value,
          "editCategory",
        );
      }

      function handleEditSubmit(e) {
        e.preventDefault();
        setLoading("btnUpdate", true);

        const f = document.getElementById("editForm"); // Use ID since form name might not be reliable or standard access
        // Construct object manually
        const formData = {
          editId: document.getElementById("editId").value,
          editDate: document.getElementById("editDate").value,
          editType: document.getElementById("editType").value,
          editAmount: parseCurrencyValue(
            document.getElementById("editAmount").value,
          ),
          editCategory: document.getElementById("editCategory").value,
          editNote: document.getElementById("editNote").value,
        };

        google.script.run
          .withSuccessHandler((res) => {
            setLoading("btnUpdate", false, "Simpan Perubahan");
            if (res.success) {
              closeEditModal();
              loadData();
              switchPage("history");
            } else showToast("Error: " + res.message, "error");
          })
          .updateTransaction(formData);
      }

      function handleDelete() {
        openConfirmModal(
          "Hapus Transaksi",
          "Yakin ingin menghapus transaksi ini?",
          function () {
            setLoading("btnDelete", true);
            google.script.run
              .withSuccessHandler((res) => {
                setLoading("btnDelete", false, "Hapus");
                if (res.success) {
                  closeEditModal();
                  loadData();
                  showToast("Transaksi dihapus", "success");
                } else showToast(res.message, "error");
              })
              .deleteTransaction(document.getElementById("editId").value);
          },
        );
      }

      function setLoading(btnId, isLoading, originalText) {
        const btn = document.getElementById(btnId);
        if (isLoading) {
          btn.disabled = true;
          btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        } else {
          btn.disabled = false;
          btn.innerHTML = originalText || "Simpan";
        }
      }

      function renderChart(labels, values) {
        const ctx = document.getElementById("expenseChart").getContext("2d");
        if (chartInstance) chartInstance.destroy();
        if (values.length === 0) return;
        chartInstance = new Chart(ctx, {
          type: "doughnut",
          data: {
            labels: labels,
            datasets: [
              {
                data: values,
                backgroundColor: [
                  "#10B981",
                  "#34D399",
                  "#6EE7B7",
                  "#A7F3D0",
                  "#FCD34D",
                  "#F87171",
                  "#60A5FA",
                ],
                borderWidth: 0,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: "right",
                labels: { boxWidth: 10, font: { size: 10 } },
              },
            },
            cutout: "70%",
          },
        });
      }

      // ============ GOALS FUNCTIONS ============
      let globalGoalsData = [];
      function loadGoals() {
        showPageLoading("goalsList");
        google.script.run
          .withSuccessHandler(renderGoals)
          .withFailureHandler(handleError)
          .getGoalsData();
      }
      function renderGoals(data) {
        if (data.error) {
          handleError(data);
          return;
        }
        globalGoalsData = data.goals || [];
        document.getElementById("goalsOverallProgress").innerText =
          (data.overallProgress || 0) + "%";
        document.getElementById("goalsTotalSaved").innerText =
          data.totalSaved || "Rp 0";
        document.getElementById("goalsTotalTarget").innerText =
          data.totalTarget || "Rp 0";
        const list = document.getElementById("goalsList");
        list.innerHTML = "";
        if (globalGoalsData.length === 0) {
          list.innerHTML =
            '<div class="text-center py-8 text-gray-300"><i class="fas fa-bullseye text-4xl mb-2"></i><p class="text-sm">Belum ada target</p></div>';
          return;
        }
        globalGoalsData.forEach((g) => {
          const progressColor = g.isCompleted
            ? "bg-emerald-500"
            : "bg-purple-500";
          list.innerHTML += `
          <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-100">
            <div onclick="openGoalHistory('${g.id}','${g.name}','${g.icon}','${
              g.fmtCurrent
            }')" class="cursor-pointer">
              <div class="flex justify-between items-start mb-2">
                <div class="flex items-center gap-2"><span class="text-2xl">${
                  g.icon
                }</span><div><p class="font-bold text-gray-800">${
                  g.name
                }</p><p class="text-xs text-gray-400">${
                  g.daysRemaining !== null
                    ? g.daysRemaining + " hari lagi"
                    : "Tanpa deadline"
                }</p></div></div>
                <div class="flex items-center gap-2"><span class="text-lg font-bold ${
                  g.isCompleted ? "text-emerald-500" : "text-purple-600"
                }">${
                  g.percentage
                }%</span><i class="fas fa-chevron-right text-gray-300 text-xs"></i></div>
              </div>
              <div class="w-full bg-gray-200 rounded-full h-2 mb-2"><div class="${progressColor} h-2 rounded-full transition-all" style="width:${
                g.percentage
              }%"></div></div>
              <div class="flex justify-between text-xs text-gray-500 mb-3"><span>${
                g.fmtCurrent
              } / ${g.fmtTarget}</span><span>Sisa: ${
                g.fmtRemaining
              }</span></div>
            </div>
            <div class="flex gap-2">
              <button onclick='openAddToGoalModal("${g.id}","${
                g.name
              }")' class="flex-1 bg-emerald-50 text-emerald-600 py-2 rounded-lg text-xs font-semibold"><i class="fas fa-plus mr-1"></i>Topup</button>
              <button onclick='openWithdrawFromGoalModal("${g.id}","${
                g.name
              }","${g.fmtCurrent}",${
                g.currentAmount
              })' class="flex-1 bg-amber-50 text-amber-600 py-2 rounded-lg text-xs font-semibold"><i class="fas fa-minus mr-1"></i>Tarik</button>
              <button onclick="deleteGoalConfirm('${
                g.id
              }')" class="bg-red-50 text-red-500 px-3 py-2 rounded-lg text-xs"><i class="fas fa-trash"></i></button>
            </div>
          </div>`;
        });
      }
      function openGoalModal() {
        document.getElementById("goalModal").classList.remove("hidden");
        document.getElementById("goalForm").reset();
        document.getElementById("goalId").value = "";
      }
      function closeGoalModal() {
        document.getElementById("goalModal").classList.add("hidden");
      }
      function handleGoalSubmit(e) {
        e.preventDefault();
        setLoading("btnSaveGoal", true);
        const formData = {
          name: document.getElementById("goalName").value,
          targetAmount: parseCurrencyValue(
            document.getElementById("goalTarget").value,
          ),
          deadline: document.getElementById("goalDeadline").value,
          icon: document.getElementById("goalIcon").value || "ðŸŽ¯",
        };
        google.script.run
          .withSuccessHandler((r) => {
            setLoading("btnSaveGoal", false, "Simpan Target");
            if (r.success) {
              closeGoalModal();
              loadGoals();
            } else showToast(r.message, "error");
          })
          .saveGoal(formData);
      }
      function openAddToGoalModal(id, name) {
        document.getElementById("addToGoalModal").classList.remove("hidden");
        document.getElementById("addToGoalId").value = id;
        document.getElementById("addToGoalName").innerText = name;
        document.getElementById("addToGoalAmount").value = "";
        document.getElementById("addToGoalNote").value = "";
        // Populate wallet dropdown
        const walletSel = document.getElementById("addToGoalWallet");
        if (walletSel) {
          walletSel.innerHTML = "";
          globalWalletsData.forEach((w) => {
            walletSel.innerHTML +=
              '<option value="' +
              w.id +
              '">' +
              w.icon +
              " " +
              w.name +
              "</option>";
          });
        }
      }
      function closeAddToGoalModal() {
        document.getElementById("addToGoalModal").classList.add("hidden");
      }
      function handleAddToGoal() {
        setLoading("btnAddToGoal", true);
        const goalId = document.getElementById("addToGoalId").value;
        const amount = parseCurrencyValue(
          document.getElementById("addToGoalAmount").value,
        );
        const note = document.getElementById("addToGoalNote").value;
        const walletId = document.getElementById("addToGoalWallet").value;
        google.script.run
          .withSuccessHandler((r) => {
            setLoading("btnAddToGoal", false, "Tambah");
            if (r.success) {
              closeAddToGoalModal();
              loadGoals();
              if (r.walletUpdated) loadWallets();
              showToast("Topup berhasil!", "success");
            } else showToast(r.message, "error");
          })
          .addToGoal(goalId, amount, note, walletId);
      }

      // Withdraw from Goal
      function openWithdrawFromGoalModal(id, name, fmtBalance, balance) {
        document
          .getElementById("withdrawFromGoalModal")
          .classList.remove("hidden");
        document.getElementById("withdrawGoalId").value = id;
        document.getElementById("withdrawGoalName").innerText = name;
        document.getElementById("withdrawGoalBalance").innerText = fmtBalance;
        document.getElementById("withdrawGoalAmount").value = "";
        document.getElementById("withdrawGoalNote").value = "";

        // Populate wallet dropdown
        const walletSel = document.getElementById("withdrawGoalWallet");
        if (walletSel) {
          walletSel.innerHTML = "";
          globalWalletsData.forEach((w) => {
            walletSel.innerHTML +=
              '<option value="' +
              w.id +
              '">' +
              w.icon +
              " " +
              w.name +
              "</option>";
          });
        }

        currentGoalData = { id, name, balance, fmtBalance };
      }
      function closeWithdrawFromGoalModal() {
        document
          .getElementById("withdrawFromGoalModal")
          .classList.add("hidden");
      }
      function handleWithdrawFromGoal() {
        setLoading("btnWithdrawGoal", true);
        const goalId = document.getElementById("withdrawGoalId").value;
        const amount = parseCurrencyValue(
          document.getElementById("withdrawGoalAmount").value,
        );
        const note = document.getElementById("withdrawGoalNote").value;
        const walletId = document.getElementById("withdrawGoalWallet").value;
        google.script.run
          .withSuccessHandler((r) => {
            setLoading("btnWithdrawGoal", false, "Tarik Dana");
            if (r.success) {
              closeWithdrawFromGoalModal();
              loadGoals();
              if (r.walletUpdated) loadWallets();
              showToast("Tarik dana berhasil!", "success");
            } else showToast(r.message, "error");
          })
          .withdrawFromGoal(goalId, amount, note, walletId);
      }

      // Goal History
      let currentGoalData = {};
      function openGoalHistory(id, name, icon, fmtBalance) {
        document.getElementById("goalHistoryModal").classList.remove("hidden");
        document.getElementById("goalHistoryTitle").innerHTML =
          icon + " " + name;
        document.getElementById("goalHistoryBalance").innerText = fmtBalance;
        document.getElementById("goalHistoryList").innerHTML =
          '<div class="text-center py-4"><i class="fas fa-spinner fa-spin text-gray-400"></i></div>';
        currentGoalData = { id, name, icon, fmtBalance };

        google.script.run
          .withSuccessHandler((data) => {
            const list = document.getElementById("goalHistoryList");
            const transactions = data.transactions || [];
            if (transactions.length === 0) {
              list.innerHTML =
                '<div class="text-center py-8 text-gray-300"><i class="fas fa-history text-4xl mb-2"></i><p class="text-sm">Belum ada riwayat</p></div>';
              return;
            }
            list.innerHTML = "";
            transactions.forEach((tx) => {
              const isTopup = tx.type === "topup";
              const icon = isTopup ? "fa-arrow-down" : "fa-arrow-up";
              const color = isTopup
                ? "text-emerald-500 bg-emerald-50"
                : "text-red-500 bg-red-50";
              const amountColor = isTopup ? "text-emerald-500" : "text-red-500";
              const prefix = isTopup ? "+" : "-";
              list.innerHTML += `
            <div class="flex items-center justify-between py-3 border-b border-gray-100 last:border-0">
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full ${color} flex items-center justify-center"><i class="fas ${icon}"></i></div>
                <div><p class="font-medium text-gray-800 text-sm">${
                  isTopup ? "Topup" : "Tarik Dana"
                }</p><p class="text-xs text-gray-400">${tx.date}${
                  tx.note ? " â€¢ " + tx.note : ""
                }</p></div>
              </div>
              <p class="font-bold ${amountColor} text-sm">${prefix}${
                tx.fmtAmount
              }</p>
            </div>`;
            });
          })
          .getGoalHistory(id);
      }
      function closeGoalHistoryModal() {
        document.getElementById("goalHistoryModal").classList.add("hidden");
      }
      function openAddToGoalFromHistory() {
        closeGoalHistoryModal();
        openAddToGoalModal(currentGoalData.id, currentGoalData.name);
      }
      function openWithdrawFromHistory() {
        closeGoalHistoryModal();
        const goal = globalGoalsData.find((g) => g.id === currentGoalData.id);
        if (goal) {
          openWithdrawFromGoalModal(
            goal.id,
            goal.name,
            goal.fmtCurrent,
            goal.currentAmount,
          );
        }
      }

      function deleteGoalConfirm(id) {
        openConfirmModal(
          "Hapus Target",
          "Hapus target ini? Semua riwayat topup/tarik juga akan dihapus.",
          function () {
            google.script.run
              .withSuccessHandler((r) => {
                if (r.success) {
                  loadGoals();
                  showToast("Target dihapus", "success");
                } else showToast("Gagal hapus", "error");
              })
              .deleteGoal(id);
          },
        );
      }

      // ============ WALLETS FUNCTIONS ============
      let globalWalletsData = [];
      function loadWallets() {
        showPageLoading("walletsList");
        google.script.run
          .withSuccessHandler(renderWallets)
          .withFailureHandler(handleError)
          .getWalletsData();
      }
      function renderWallets(data) {
        if (data.error) {
          handleError(data);
          return;
        }
        globalWalletsData = data.wallets || [];
        document.getElementById("netWorthDisplay").innerText =
          data.netWorth || "Rp 0";
        const list = document.getElementById("walletsList");
        list.innerHTML = "";
        if (globalWalletsData.length === 0) {
          list.innerHTML =
            '<div class="text-center py-8 text-gray-300"><i class="fas fa-wallet text-4xl mb-2"></i><p class="text-sm">Belum ada wallet</p></div>';
          return;
        }
        globalWalletsData.forEach((w) => {
          const balanceColor =
            w.currentBalance >= 0 ? "text-emerald-600" : "text-red-500";
          list.innerHTML += `
          <div onclick="openWalletHistory('${w.id}','${w.name}','${w.icon}','${w.fmtBalance}')" class="bg-white rounded-xl p-4 shadow-sm border border-gray-100 flex items-center justify-between cursor-pointer hover:bg-gray-50 active:scale-[0.98] transition-all">
            <div class="flex items-center gap-3"><span class="text-2xl">${w.icon}</span><div><p class="font-bold text-gray-800">${w.name}</p><p class="text-xs text-gray-400 capitalize">${w.type}</p></div></div>
            <div class="flex items-center gap-2"><p class="font-bold ${balanceColor}">${w.fmtBalance}</p><i class="fas fa-chevron-right text-gray-300 text-xs"></i></div>
          </div>`;
        });
      }
      function openWalletModal() {
        document.getElementById("walletModal").classList.remove("hidden");
        document.getElementById("walletForm").reset();
      }
      function closeWalletModal() {
        document.getElementById("walletModal").classList.add("hidden");
      }
      function handleWalletSubmit(e) {
        e.preventDefault();
        setLoading("btnSaveWallet", true);
        const formData = {
          name: document.getElementById("walletName").value,
          type: document.getElementById("walletType").value,
          initialBalance: parseCurrencyValue(
            document.getElementById("walletInitial").value,
          ),
          icon: document.getElementById("walletIcon").value || "ðŸ’°",
        };
        google.script.run
          .withSuccessHandler((r) => {
            setLoading("btnSaveWallet", false, "Simpan Wallet");
            if (r.success) {
              closeWalletModal();
              loadWallets();
            } else showToast(r.message, "error");
          })
          .saveWallet(formData);
      }
      function openTransferModal() {
        document.getElementById("transferModal").classList.remove("hidden");
        const fromSel = document.getElementById("transferFrom");
        const toSel = document.getElementById("transferTo");
        fromSel.innerHTML = "";
        toSel.innerHTML = "";
        globalWalletsData.forEach((w) => {
          fromSel.innerHTML += `<option value="${w.id}">${w.icon} ${w.name}</option>`;
          toSel.innerHTML += `<option value="${w.id}">${w.icon} ${w.name}</option>`;
        });
      }
      function closeTransferModal() {
        document.getElementById("transferModal").classList.add("hidden");
      }
      function handleTransfer() {
        setLoading("btnTransfer", true);
        const from = document.getElementById("transferFrom").value;
        const to = document.getElementById("transferTo").value;
        const amount = parseCurrencyValue(
          document.getElementById("transferAmount").value,
        );
        const note = document.getElementById("transferNote").value;
        if (from === to) {
          showToast("Wallet asal dan tujuan tidak boleh sama", "warning");
          setLoading("btnTransfer", false, "Transfer");
          return;
        }
        google.script.run
          .withSuccessHandler((r) => {
            setLoading("btnTransfer", false, "Transfer");
            if (r.success) {
              closeTransferModal();
              loadWallets();
              showToast("Transfer berhasil!", "success");
            } else showToast(r.message, "error");
          })
          .transferBetweenWallets(from, to, amount, note);
      }

      // Wallet History Functions
      function openWalletHistory(
        walletId,
        walletName,
        walletIcon,
        walletBalance,
      ) {
        document
          .getElementById("walletHistoryModal")
          .classList.remove("hidden");
        document.getElementById("walletHistoryTitle").innerHTML =
          walletIcon + " " + walletName;
        document.getElementById("walletHistoryBalance").innerText =
          "Saldo: " + walletBalance;

        // Filter transactions by wallet ID
        const filtered = globalTransactionData.filter(
          (t) => (t.walletId || "WALLET-CASH") === walletId,
        );
        const list = document.getElementById("walletHistoryList");
        list.innerHTML = "";

        if (filtered.length === 0) {
          list.innerHTML =
            '<div class="text-center py-8 text-gray-300"><i class="fas fa-receipt text-4xl mb-2"></i><p class="text-sm">Belum ada transaksi</p></div>';
          return;
        }

        filtered.forEach((item) => {
          const isExpense = item.rawType === "Expense";
          const icon = isExpense ? "fa-arrow-up" : "fa-arrow-down";
          const color = isExpense
            ? "text-red-500 bg-red-50"
            : "text-emerald-500 bg-emerald-50";
          const amountColor = isExpense ? "text-red-500" : "text-emerald-500";
          const prefix = isExpense ? "-" : "+";
          list.innerHTML += `
          <div class="flex items-center justify-between py-3 border-b border-gray-100 last:border-0">
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 rounded-full ${color} flex items-center justify-center"><i class="fas ${icon}"></i></div>
              <div><p class="font-medium text-gray-800 text-sm">${
                item.category
              }</p><p class="text-xs text-gray-400">${item.date}${
                item.note ? " â€¢ " + item.note : ""
              }</p></div>
            </div>
            <p class="font-bold ${amountColor} text-sm">${prefix}${
              item.fmtAmount
            }</p>
          </div>`;
        });
      }
      function closeWalletHistoryModal() {
        document.getElementById("walletHistoryModal").classList.add("hidden");
      }

      // ============ REPORTS FUNCTIONS ============
      function loadReports() {
        showPageLoading("reportsList");
        populateReportDropdowns();
        google.script.run
          .withSuccessHandler(renderReportsList)
          .withFailureHandler(handleError)
          .getReportsList();
      }
      function populateReportDropdowns() {
        const monthSel = document.getElementById("reportMonth");
        const yearSel = document.getElementById("reportYear");
        const months = [
          "Januari",
          "Februari",
          "Maret",
          "April",
          "Mei",
          "Juni",
          "Juli",
          "Agustus",
          "September",
          "Oktober",
          "November",
          "Desember",
        ];
        monthSel.innerHTML = "";
        months.forEach((m, i) => {
          monthSel.innerHTML += `<option value="${i + 1}" ${
            i + 1 === new Date().getMonth() + 1 ? "selected" : ""
          }>${m}</option>`;
        });
        yearSel.innerHTML = "";
        const curYear = new Date().getFullYear();
        for (let y = curYear; y >= curYear - 3; y--) {
          yearSel.innerHTML += `<option value="${y}">${y}</option>`;
        }
      }
      function renderReportsList(data) {
        const list = document.getElementById("reportsList");
        list.innerHTML = "";
        if (!data.reports || data.reports.length === 0) {
          list.innerHTML =
            '<p class="text-xs text-gray-400 text-center">Belum ada laporan</p>';
          return;
        }
        data.reports.forEach((r) => {
          list.innerHTML += `<a href="${r.docUrl}" target="_blank" class="flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors"><div><p class="font-semibold text-sm">${r.monthName} ${r.year}</p><p class="text-xs text-gray-400">Dibuat: ${r.createdAt}</p></div><i class="fas fa-external-link-alt text-gray-400"></i></a>`;
        });
      }
      function handleGenerateReport() {
        setLoading("btnGenReport", true);
        const month = parseInt(document.getElementById("reportMonth").value);
        const year = parseInt(document.getElementById("reportYear").value);
        google.script.run
          .withSuccessHandler((r) => {
            setLoading(
              "btnGenReport",
              false,
              '<i class="fas fa-file-pdf mr-2"></i> Generate Laporan',
            );
            if (r.success) {
              showToast("Laporan berhasil dibuat!", "success");
              window.open(r.docUrl, "_blank");
              loadReports();
            } else showToast(r.message, "error");
          })
          .generateMonthlyReport(month, year);
      }

      // ============ BUDGET FUNCTIONS ============
      function loadBudgets() {
        showPageLoading("manageBudgetList");
        google.script.run
          .withSuccessHandler(renderBudgets)
          .withFailureHandler(handleError)
          .getBudgetsList();
      }

      function renderBudgets(data) {
        if (data.error) {
          handleError(data);
          return;
        }

        const list = document.getElementById("manageBudgetList");
        list.innerHTML = "";

        if (
          !data.budgets ||
          !Array.isArray(data.budgets) ||
          data.budgets.length === 0
        ) {
          console.warn("No budgets found or invalid format", data.budgets);
          list.innerHTML =
            '<div class="text-center py-8 text-gray-300"><p class="text-sm">Belum ada budget</p></div>';
          return;
        }

        try {
          let html = "";
          data.budgets.forEach((b) => {
            if (!b) return;
            html += `
            <div class="flex items-center justify-between p-4 hover:bg-gray-50 transition-colors border-b border-gray-50 last:border-0">
              <div class="flex items-center gap-4">
                <div class="w-10 h-10 rounded-full bg-emerald-100 flex items-center justify-center">
                  <i class="fas fa-tag text-emerald-600"></i>
                </div>
                <div>
                   <p class="font-bold text-gray-800">${
                     b.category || "Unknown"
                   }</p>
                   <p class="text-xs text-gray-400">Limit: ${
                     b.fmtLimit || "Rp 0"
                   }</p>
                </div>
              </div>
              <button onclick="openEditBudgetModal('${b.category}', ${
                b.limit
              })" class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center text-gray-400 hover:bg-emerald-500 hover:text-white transition-all">
                <i class="fas fa-pen text-xs"></i>
              </button>
            </div>
          `;
          });
          list.innerHTML = html;
        } catch (e) {
          console.error("Render error:", e);
          list.innerHTML =
            '<p class="text-red-500 p-4">Error rendering list: ' +
            e.message +
            "</p>";
        }
      }

      function openEditBudgetModal(category, limit) {
        document.getElementById("editBudgetModal").classList.remove("hidden");
        document.getElementById("editBudgetCategory").value = category;
        // Format limit
        document.getElementById("editBudgetLimit").value =
          new Intl.NumberFormat("id-ID").format(limit);
      }

      function closeEditBudgetModal() {
        document.getElementById("editBudgetModal").classList.add("hidden");
      }

      function handleSaveBudget() {
        setLoading("btnSaveBudget", true);
        const category = document.getElementById("editBudgetCategory").value;
        const limit = parseCurrencyValue(
          document.getElementById("editBudgetLimit").value,
        );

        google.script.run
          .withSuccessHandler((r) => {
            setLoading("btnSaveBudget", false, "Simpan Perubahan");
            if (r.success) {
              closeEditBudgetModal();
              loadBudgets();
              showToast("Budget updated!", "success");
            } else {
              showToast(r.message, "error");
            }
          })
          .saveBudget(category, limit);
      }

      // ============ END BUDGET FUNCTIONS ============
    </script>
  </body>
</html>
